---
import "@fontsource-variable/inter";
import "../styles/global.css";
import { ViewTransitions } from "astro:transitions";

type Props = {
  title?: string;
  description?: string;
  ogImage?: string;
  fullBleed?: boolean;
};

const { title, description, ogImage, fullBleed } = Astro.props;

const defaultDescription = "Science-built cook-at-home dog food kits with AAFCO-aligned nutrition, transparent MER modeling, and weekly ingredient delivery.";
const pageTitle = title ? `${title} | Dogology` : "Dogology — Science-Built Food for More Good Years";
const pageDescription = description || defaultDescription;
const canonicalUrl = new URL(Astro.url.pathname, Astro.site);
const ogImageUrl = new URL(ogImage || "/hero.jpg", Astro.site);

const pathname = Astro.url.pathname;

// Auto-breadcrumbs from URL path
const segmentLabels: Record<string, string> = {
  recipes: "Recipes",
  recipe: "Recipe Builder",
  specs: "Specs",
  ingredients: "Ingredients",
  library: "Library",
  plan: "Plan",
  admin: "Admin",
  business: "Business",
  manufacturer: "Manufacturers",
};

function labelify(s: string): string {
  return segmentLabels[s] ?? s.replace(/[-_]/g, " ").replace(/\b\w/g, (c) => c.toUpperCase());
}

const segments = pathname.replace(/\/$/, "").split("/").filter(Boolean);
const crumbs: { label: string; href: string }[] = [];
if (segments.length > 1) {
  for (let i = 0; i < segments.length; i++) {
    const href = "/" + segments.slice(0, i + 1).join("/");
    const label = labelify(segments[i]);
    crumbs.push({ label, href });
  }
}
---

<!doctype html>
<html lang="en">
  <head>
    <meta charset="utf-8" />
    <meta name="viewport" content="width=device-width" />
    <meta name="generator" content={Astro.generator} />
    <title>{pageTitle}</title>
    <meta name="description" content={pageDescription} />
    <link rel="canonical" href={canonicalUrl.href} />

    <!-- Open Graph -->
    <meta property="og:type" content="website" />
    <meta property="og:site_name" content="Dogology" />
    <meta property="og:title" content={pageTitle} />
    <meta property="og:description" content={pageDescription} />
    <meta property="og:url" content={canonicalUrl.href} />
    <meta property="og:image" content={ogImageUrl.href} />

    <!-- Twitter / X -->
    <meta name="twitter:card" content="summary_large_image" />
    <meta name="twitter:title" content={pageTitle} />
    <meta name="twitter:description" content={pageDescription} />
    <meta name="twitter:image" content={ogImageUrl.href} />

    <ViewTransitions />
  </head>
  <body>
    <header class="site-header" transition:persist>
      <div class="container site-header__inner">
        <a href="/" class="site-logo" aria-label="Dogology home">
          <span class="site-logo__mark">●</span>
          <span class="site-logo__name">Dogology</span>
        </a>
        <nav class="site-nav" aria-label="Primary">
          <a href="/recipes" class:list={["site-nav__link", { "site-nav__link--active": pathname.startsWith("/recipes") }]}>Recipes</a>
          <a href="/library" class:list={["site-nav__link", { "site-nav__link--active": pathname.startsWith("/library") || pathname.startsWith("/specs") || pathname.startsWith("/ingredients") }]}>Library</a>
        </nav>
      </div>
    </header>

    <main class:list={["", { "full-bleed": fullBleed }]}>
      <div class={fullBleed ? undefined : "container"}>
        {crumbs.length > 0 && (
          <nav class="breadcrumb" aria-label="Breadcrumb">
            <a href="/">Home</a>
            {crumbs.map((c, i) => (
              <>
                <span class="breadcrumb__sep" aria-hidden="true">›</span>
                {i < crumbs.length - 1
                  ? <a href={c.href}>{c.label}</a>
                  : <span class="breadcrumb__current" aria-current="page">{c.label}</span>
                }
              </>
            ))}
          </nav>
        )}
        <slot />
      </div>
    </main>

    <footer class="site-footer">
      <div class="container">Dogology</div>
    </footer>

    <script>
      // ── Scroll reveal ──────────────────────────────────────────
      function initReveal() {
        const els = document.querySelectorAll(".reveal");
        if (!els.length) return;

        const prefersReduced = matchMedia("(prefers-reduced-motion: reduce)").matches;
        if (prefersReduced) {
          els.forEach(el => el.classList.add("revealed"));
          return;
        }

        const io = new IntersectionObserver((entries) => {
          for (const entry of entries) {
            if (entry.isIntersecting) {
              entry.target.classList.add("revealed");
              io.unobserve(entry.target);
            }
          }
        }, { threshold: 0.08, rootMargin: "0px 0px -40px 0px" });

        els.forEach(el => io.observe(el));
      }

      // Run on initial load
      initReveal();

      // Re-run after View Transition navigation
      document.addEventListener("astro:page-load", initReveal);
    </script>

    <script>
      // Render mermaid diagrams in markdown pages
      async function initMermaid() {
        const codeBlocks = document.querySelectorAll("pre code.language-mermaid");
        if (codeBlocks.length > 0) {
          const { default: mermaid } = await import("https://cdn.jsdelivr.net/npm/mermaid@11/dist/mermaid.esm.min.mjs");
          mermaid.initialize({ startOnLoad: false, theme: "neutral" });
          for (const code of codeBlocks) {
            const pre = code.parentElement;
            const definition = code.textContent ?? "";
            const div = document.createElement("div");
            div.className = "mermaid-diagram";
            div.style.overflowX = "auto";
            div.style.margin = "1.5rem 0";
            const { svg } = await mermaid.render(
              "mermaid-" + Math.random().toString(36).slice(2),
              definition
            );
            div.innerHTML = svg;
            pre.replaceWith(div);
          }
        }
      }

      initMermaid();
      document.addEventListener("astro:page-load", initMermaid);
    </script>
  </body>
</html>

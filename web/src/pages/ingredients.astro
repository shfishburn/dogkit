---
import BaseLayout from "../layouts/BaseLayout.astro";
import { readFile } from "node:fs/promises";
import path from "node:path";

type Ingredient = {
  id: string;
  name: string;
  category: string;
  tier: string;
  usda_fdc_id?: number;
  default_unit?: string;
  notes?: string;
  dimensions?: Record<string, string>;
};

type IngredientDb = {
  metadata?: {
    dimensions?: Record<string, string>;
    availability_tiers?: Record<string, string>;
  };
  ingredients: Ingredient[];
};

function titleCaseCategory(category: string): string {
  return category
    .split("_")
    .filter(Boolean)
    .map((w) => w.charAt(0).toUpperCase() + w.slice(1))
    .join(" ");
}

function stableSort<T>(items: T[], toKey: (x: T) => string): T[] {
  return [...items].sort((a, b) => toKey(a).localeCompare(toKey(b)));
}

const jsonPath = path.resolve(process.cwd(), "..", "data", "ingredients", "ingredients.json");
const raw = await readFile(jsonPath, "utf-8");
const db = JSON.parse(raw) as IngredientDb;

const dimensionLabels = db.metadata?.dimensions ?? {};
const tierLabels = db.metadata?.availability_tiers ?? {};

const byCategory = new Map<string, Ingredient[]>();
for (const ing of db.ingredients ?? []) {
  const category = ing.category ?? "uncategorized";
  const arr = byCategory.get(category) ?? [];
  arr.push(ing);
  byCategory.set(category, arr);
}

const categories = stableSort(Array.from(byCategory.keys()), (c) => c);
const categorySections = categories.map((c) => ({
  key: c,
  label: titleCaseCategory(c),
  items: stableSort(byCategory.get(c) ?? [], (i) => i.name ?? i.id),
}));
---

<BaseLayout title="Ingredients" description="Browse the full canine ingredient database with nutrient dimensions, availability tiers, and USDA FoodData Central references.">

  <div class="page-header">
    <div class="page-header__top">
      <p class="section-label">Database &middot; {db.ingredients?.length ?? 0} ingredients</p>
      <button class="button no-print" type="button" onclick="window.print()">Print</button>
    </div>
    <h1 class="section-headline" style="font-size:var(--text-3xl);">Ingredient Database</h1>
    <p class="page-sub">Complete nutrient dimension coverage, availability tiers, and USDA FoodData Central references for every ingredient in the Dogology system.</p>
  </div>

  <!-- Category jump nav -->
  <nav class="ing-jumps" aria-label="Jump to category">
    {categorySections.map((c) => (
      <a href={`#${c.key}`} class="ing-jump-link">{c.label} <span class="ing-jump-count">{c.items.length}</span></a>
    ))}
  </nav>

  <!-- Category sections -->
  {categorySections.map((c) => (
    <section id={c.key} class="ing-section">
      <h2 class="ing-section__title">{c.label} <span class="ing-section__count">{c.items.length}</span></h2>
      <div class="ing-table-wrap">
        <table class="ing-table">
          <thead>
            <tr>
              <th>Ingredient</th>
              <th>Tier</th>
              <th>Notes</th>
              <th>Nutrients</th>
            </tr>
          </thead>
          <tbody>
            {c.items.map((ing) => {
              const dims = ing.dimensions ?? {};
              const dimsText = Object.entries(dims)
                .map(([k, v]) => `${dimensionLabels[k] ?? k}: ${v}`)
                .join(", ");
              const tierText = tierLabels[ing.tier] ? `${ing.tier} — ${tierLabels[ing.tier]}` : ing.tier;
              return (
                <tr>
                  <td>
                    <strong class="ing-name">{ing.name}</strong>
                    {ing.usda_fdc_id && <div class="ing-meta">USDA FDC {ing.usda_fdc_id}{ing.default_unit ? ` · ${ing.default_unit}` : ""}</div>}
                  </td>
                  <td><span class="tier-badge">{tierText}</span></td>
                  <td class="ing-notes">{ing.notes ?? ""}</td>
                  <td class="ing-dims">{dimsText}</td>
                </tr>
              );
            })}
          </tbody>
        </table>
      </div>
    </section>
  ))}

</BaseLayout>

---
import BaseLayout from "../../layouts/BaseLayout.astro";
import { loadWeeklyMealPlan } from "../../lib/loaders";
import { supabaseRenderImageUrl, supabaseSrcSetWH } from "../../lib/supabaseImages";

const mealPlan = await loadWeeklyMealPlan();
const recipes = mealPlan.recipes;
const sizing = mealPlan.metadata.size_scaling;
const weeklyPlan = mealPlan.weekly_plan;

const { id } = Astro.params;
const recipe = recipes.find((r) => r.id === id);

if (!recipe) {
  return Astro.redirect("/recipes");
}

function labelify(s: string): string {
  return s.replace(/_/g, " ").replace(/\b\w/g, (c) => c.toUpperCase());
}

const protein = recipe.tags?.protein_type ?? "";
const carb = recipe.tags?.primary_carb ?? "";
const veggie = recipe.tags?.primary_veggie ?? "";
const tier = recipe.tags?.tier ?? "";
const prep = recipe.tags?.prep_time_min ?? 0;
const nutrients = recipe.per_1000kcal_estimate ?? {};

const heroImageUrl = recipe.image_url;
const heroSrc = heroImageUrl
  ? supabaseRenderImageUrl(heroImageUrl, {
      width: 960,
      height: 600,
      resize: "cover",
      quality: 75,
    })
  : null;
const heroSrcSet = heroImageUrl
  ? supabaseSrcSetWH(
      heroImageUrl,
      [
        { width: 480, height: 300 },
        { width: 640, height: 400 },
        { width: 960, height: 600 },
        { width: 1280, height: 800 },
      ],
      {
        resize: "cover",
        quality: 75,
      }
    )
  : null;

const appearances: { day: number; label: string; meal: string }[] = [];
for (const day of weeklyPlan.days ?? []) {
  if (day.am?.recipe_id === id) appearances.push({ day: day.day, label: day.label, meal: "AM" });
  if (day.pm?.recipe_id === id) appearances.push({ day: day.day, label: day.label, meal: "PM" });
}

export async function getStaticPaths() {
  const plan = await loadWeeklyMealPlan();
  return plan.recipes.map((r) => ({ params: { id: r.id } }));
}
---

<BaseLayout title={recipe.name} description={recipe.overview} container="lg">
  <article class="rd">

    {/* Hero image */}
    {heroImageUrl && heroSrc && heroSrcSet && (
      <figure class="rd__hero">
        <img
          class="rd__hero-img"
          src={heroSrc}
          srcset={heroSrcSet}
          sizes="(max-width: 72rem) 100vw, 72rem"
          alt={recipe.name}
          width="960"
          height="600"
          loading="eager"
          decoding="async"
        />
      </figure>
    )}

    {/* Header */}
    <header class="rd__header reveal">
      <div class="rd__meta">
        <span class:list={["badge", tier === "T2" ? "badge--t2" : "badge--t1"]}>{tier}</span>
        <span class="badge badge--time">{prep} min</span>
        <span class="tag tag--protein">{labelify(protein)}</span>
        <span class="tag tag--carb">{labelify(carb)}</span>
        <span class="tag tag--veggie">{labelify(veggie)}</span>
      </div>
      <h1 class="rd__title">{recipe.name}</h1>
      <p class="rd__overview">{recipe.overview}</p>
      <div class="rd__actions no-print">
        <button type="button" class="action-btn" id="share-btn" title="Share recipe">
          <svg width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><circle cx="18" cy="5" r="3"/><circle cx="6" cy="12" r="3"/><circle cx="18" cy="19" r="3"/><line x1="8.59" y1="13.51" x2="15.42" y2="17.49"/><line x1="15.41" y1="6.51" x2="8.59" y2="10.49"/></svg>
          <span>Share</span>
        </button>
        <button type="button" class="action-btn" id="print-btn" title="Print recipe">
          <svg width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><polyline points="6 9 6 2 18 2 18 9"/><path d="M6 18H4a2 2 0 0 1-2-2v-5a2 2 0 0 1 2-2h16a2 2 0 0 1 2 2v5a2 2 0 0 1-2 2h-2"/><rect x="6" y="14" width="12" height="8"/></svg>
          <span>Print</span>
        </button>
      </div>
    </header>

    {/* Size selector */}
    <section class="rd__section no-print reveal">
      <h2 class="rd__section-title">Dog size</h2>
      <div class="pill-row" id="size-picker">
        {(["small", "medium", "large"] as const).map((key) => {
          const val = sizing[key];
          return (
          <button
            type="button"
            class:list={["pill", { "pill--active": key === "medium" }]}
            data-size={key}
          >
            {key.charAt(0).toUpperCase() + key.slice(1)}
            <span class="pill-sub">{val.weight_kg} kg · {val.approx_mer_kcal} kcal</span>
          </button>
        );
        })}
      </div>
    </section>

    {/* Ingredients */}
    <section class="rd__section reveal">
      <h2 class="rd__section-title">Ingredients</h2>
      <div class="rd__ing-card">
        {recipe.ingredients.map((ing) => (
          <div class="rd__ing">
            <div class="rd__ing-left">
              <span class="rd__ing-name">{ing.name}</span>
              {ing.prep && <span class="rd__ing-prep">{ing.prep}</span>}
            </div>
            {ing.base_g != null && (
              <span
                class="rd__ing-amount"
                data-base-g={ing.base_g}
                data-unit={ing.unit}
              >
                {Math.round(ing.base_g * 0.95)} {ing.unit}
              </span>
            )}
          </div>
        ))}
      </div>
    </section>

    {/* Instructions */}
    <section class="rd__section reveal">
      <h2 class="rd__section-title">Instructions</h2>
      <ol class="rd__steps">
        {recipe.instructions.map((step: string, i: number) => (
          <li class="rd__step">
            <span class="rd__step-num">{i + 1}</span>
            <span class="rd__step-text">{step}</span>
          </li>
        ))}
      </ol>
    </section>

    {/* Nutrition */}
    <section class="rd__section reveal">
      <h2 class="rd__section-title">Nutrition per 1,000 kcal</h2>
      <div class="rd__stat-grid">
        <div class="rd__stat">
          <span class="rd__stat-val">{nutrients.protein_g}<small>g</small></span>
          <span class="rd__stat-lbl">Protein</span>
        </div>
        <div class="rd__stat">
          <span class="rd__stat-val">{nutrients.fat_g}<small>g</small></span>
          <span class="rd__stat-lbl">Fat</span>
        </div>
        <div class="rd__stat">
          <span class="rd__stat-val">{nutrients.fiber_g}<small>g</small></span>
          <span class="rd__stat-lbl">Fiber</span>
        </div>
        <div class="rd__stat">
          <span class="rd__stat-val">{nutrients.ca_p_ratio}</span>
          <span class="rd__stat-lbl">Ca:P</span>
        </div>
        <div class="rd__stat">
          <span class="rd__stat-val">{nutrients.calcium_mg}<small>mg</small></span>
          <span class="rd__stat-lbl">Calcium</span>
        </div>
      </div>
      {recipe.tags?.dimensions_covered?.length > 0 && (
        <div class="rd__dimensions">
          <h3 class="rd__section-title">Dimensions covered</h3>
          <div class="dim-chips">
            {recipe.tags.dimensions_covered.map((d: string) => (
              <span class="dim-chip">{d}</span>
            ))}
          </div>
        </div>
      )}
    </section>

    {/* Meal plan appearances */}
    {appearances.length > 0 && (
      <section class="rd__section reveal">
        <h2 class="rd__section-title">In the meal plan</h2>
        <div class="rd__plan-chips">
          {appearances.map((a) => (
            <span class:list={["plan-chip", a.meal === "AM" ? "plan-chip--am" : "plan-chip--pm"]}>
              {a.label} · {a.meal}
            </span>
          ))}
        </div>
      </section>
    )}

    {/* Copy JSON */}
    <section class="rd__section no-print reveal">
      <h2 class="rd__section-title">Recipe data</h2>
      <div class="rd__actions">
        <button type="button" class="action-btn" id="copy-json-btn" title="Copy recipe JSON">
          <svg width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><rect x="9" y="9" width="13" height="13" rx="2" ry="2"/><path d="M5 15H4a2 2 0 0 1-2-2V4a2 2 0 0 1 2-2h9a2 2 0 0 1 2 2v1"/></svg>
          <span>Copy recipe JSON</span>
        </button>
      </div>
    </section>
  </article>
</BaseLayout>

<script define:vars={{ sizing, RECIPE: recipe }}>
  let activeSize = "medium";
  const sizePicker = document.getElementById("size-picker");

  function applySize(sizeKey) {
    const factor = sizing[sizeKey]?.factor ?? 0.95;
    for (const el of document.querySelectorAll("[data-base-g]")) {
      const base = parseFloat(el.dataset.baseG);
      if (!isNaN(base)) {
        const unit = el.dataset.unit ?? "g";
        el.textContent = `${Math.round(base * factor)} ${unit}`;
      }
    }
  }

  sizePicker.addEventListener("click", (e) => {
    const btn = e.target.closest("button[data-size]");
    if (!btn) return;
    for (const p of sizePicker.querySelectorAll(".pill")) p.classList.remove("pill--active");
    btn.classList.add("pill--active");
    activeSize = btn.dataset.size;
    applySize(activeSize);
  });

  applySize("medium");

  const shareBtn = document.getElementById("share-btn");
  shareBtn.addEventListener("click", async () => {
    const title = document.querySelector(".rd__title")?.textContent ?? "Recipe";
    const url = window.location.href;
    if (navigator.share) {
      try { await navigator.share({ title, url }); } catch {}
    } else {
      await navigator.clipboard.writeText(url);
      const label = shareBtn.querySelector("span");
      const prev = label.textContent;
      label.textContent = "Copied!";
      setTimeout(() => { label.textContent = prev; }, 2000);
    }
  });

  document.getElementById("print-btn").addEventListener("click", () => window.print());

  const copyJsonBtn = document.getElementById('copy-json-btn');
  copyJsonBtn?.addEventListener('click', async () => {
    if (!navigator.clipboard) return;
    try {
      await navigator.clipboard.writeText(JSON.stringify(RECIPE, null, 2));
      const label = copyJsonBtn.querySelector('span');
      const prev = label.textContent;
      label.textContent = 'Copied!';
      setTimeout(() => { label.textContent = prev; }, 2000);
    } catch {}
  });
</script>

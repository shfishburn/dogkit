---
import BaseLayout from "../layouts/BaseLayout.astro";
import { getCollection } from "astro:content";
import { loadPlanItems } from "../lib/loaders";
import type { PlanItem } from "../lib/schemas";

const plan = await loadPlanItems();
const byPhase = new Map<string, PlanItem[]>();
for (const item of plan) {
  const arr = byPhase.get(item.phase) ?? [];
  arr.push(item);
  byPhase.set(item.phase, arr);
}
const phases = Array.from(byPhase.keys()).sort((a, b) => Number(a) - Number(b));

const adminTools = [
  {
    href: "/admin/business",
    icon: "ðŸ“‹",
    title: "Business Documents",
    description: "Business plan, financial model, and operational documents.",
    label: "Business",
  },
  {
    href: "/admin/manufacturer",
    icon: "ðŸ­",
    title: "Manufacturer Candidates",
    description: "Co-manufacturer evaluation and candidate tracking.",
    label: "Mfg",
  },
  {
    href: "#project-plan",
    icon: "âœ…",
    title: "Project Plan",
    description: "Phased project checklist with task tracking and milestones.",
    label: "Plan",
  },
];

// â”€â”€ Spec docs from content collection â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
function slugifySegment(s: string): string {
  return s.trim().replace(/\.md$/i, "").toLowerCase().replace(/[^a-z0-9]+/g, "-").replace(/(^-|-$)/g, "");
}
function entryToSlug(id: string): string {
  return id.split("/").map(slugifySegment).filter(Boolean).join("/");
}
function humanTitle(id: string): string {
  const base = id.replace(/\.md$/i, "").replace(/^.*\//, "");
  return base.replace(/[-_]+/g, " ").replace(/\b\w/g, (c) => c.toUpperCase());
}
function categoryFromId(id: string): string {
  const parts = id.split("/");
  if (parts.length < 2) return "Overview";
  const folder = parts[0];
  const map: Record<string, string> = {
    research: "Research",
    business: "Business",
    app: "Pipeline",
    human: "Comparison",
    ingredients: "Database",
  };
  return map[folder] ?? folder.charAt(0).toUpperCase() + folder.slice(1);
}

const entries = await getCollection("specs");
const docs = entries
  .map((entry) => ({
    href: `/specs/${entryToSlug(entry.id)}`,
    title: entry.data.title ?? humanTitle(entry.id),
    category: categoryFromId(entry.id),
    body: entry.body?.slice(0, 200).replace(/[#*>`\-_\[\]]/g, "").trim() ?? "",
  }))
  .sort((a, b) => a.category.localeCompare(b.category) || a.title.localeCompare(b.title));

// Group docs by category
const docsByCategory = new Map<string, typeof docs>();
for (const doc of docs) {
  const arr = docsByCategory.get(doc.category) ?? [];
  arr.push(doc);
  docsByCategory.set(doc.category, arr);
}
const categoryOrder = ["Overview", "Research", "Pipeline", "Business", "Comparison", "Database"];
const sortedCategories = [...docsByCategory.keys()].sort(
  (a, b) => {
    const ai = categoryOrder.indexOf(a);
    const bi = categoryOrder.indexOf(b);
    if (ai === -1 && bi === -1) return a.localeCompare(b);
    if (ai === -1) return 1;
    if (bi === -1) return -1;
    return ai - bi;
  }
);
---

<BaseLayout title="Library" description="All Dogology tools and research documents â€” ingredient database, recipes, meal plan calculator, and science references.">

  <div class="lib-hero">
    <div class="page-header__top">
      <p class="section-label">Knowledge Base</p>
      <button class="button no-print" type="button" onclick="window.print()">Print</button>
    </div>
    <h1 class="lib-hero__headline">Library</h1>
    <p class="lib-hero__sub">Admin tools, research documents, and specs behind every Dogology meal.</p>
  </div>

  <!-- â”€â”€ Admin â”€â”€ -->
  <section class="lib-section">
    <h2 class="lib-section__title">Admin</h2>
    <div class="lib-grid lib-grid--tools">
      {adminTools.map((t) => (
        <a href={t.href} class="lib-card lib-card--tool">
          <div class="lib-card__icon">{t.icon}</div>
          <div class="lib-card__body">
            <span class="lib-badge">{t.label}</span>
            <h3 class="lib-card__title">{t.title}</h3>
            <p class="lib-card__desc">{t.description}</p>
          </div>
          <span class="lib-card__arrow" aria-hidden="true">â†’</span>
        </a>
      ))}
    </div>
  </section>

  <!-- â”€â”€ Project Plan â”€â”€ -->
  <section class="lib-section" id="project-plan">
    <h2 class="lib-section__title">Project Plan</h2>
    <p class="small" style="margin-bottom: var(--space-4);">Source: <code>plan/plan.json</code></p>
    <div class="plan-checklist">
      {phases.map((phase) => (
        <details class="plan-phase" open>
          <summary class="plan-phase__summary">
            <strong>Phase {phase}</strong>
          </summary>
          <ul class="plan-phase__list">
            {byPhase.get(phase)!.map((t) => (
              <li class="plan-task">
                <label class="plan-task__label">
                  <input type="checkbox" class="plan-task__checkbox" name={`task-${t.task_id}`} />
                  <span class="plan-task__body">
                    <span class="plan-task__top">
                      <span class="plan-task__id">{t.task_id}</span>
                      <span class="plan-task__title">{t.title}</span>
                      <span class="plan-task__time">{t.month_range}</span>
                    </span>
                    <span class="plan-task__desc">{t.description}</span>
                  </span>
                </label>
              </li>
            ))}
          </ul>
        </details>
      ))}
    </div>
  </section>

  <!-- â”€â”€ Research & Docs â”€â”€ -->
  <section class="lib-section">
    <h2 class="lib-section__title">Research &amp; Docs</h2>
    {sortedCategories.map((cat) => (
      <div class="lib-category">
        <h3 class="lib-category__title">{cat}</h3>
        <div class="lib-grid lib-grid--docs">
          {docsByCategory.get(cat)!.map((doc) => (
            <a href={doc.href} class="lib-card lib-card--doc">
              <div class="lib-card__body">
                <h4 class="lib-card__title">{doc.title}</h4>
                {doc.body && <p class="lib-card__desc">{doc.body}{doc.body.length >= 200 ? "â€¦" : ""}</p>}
              </div>
              <span class="lib-card__arrow" aria-hidden="true">â†’</span>
            </a>
          ))}
        </div>
      </div>
    ))}
  </section>

</BaseLayout>

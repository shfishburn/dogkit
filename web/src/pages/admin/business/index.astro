---
import BaseLayout from "../../../layouts/BaseLayout.astro";
import { getCollection } from "astro:content";
import { readFile } from "node:fs/promises";
import path from "node:path";

function stripMarkdown(s: string): string {
  return s
    .replace(/\[([^\]]+)\]\([^\)]+\)/g, "$1")
    .replace(/\*\*([^*]+)\*\*/g, "$1")
    .replace(/\*([^*]+)\*/g, "$1")
    .replace(/`([^`]+)`/g, "$1")
    .replace(/\s+/g, " ")
    .trim();
}

function extractTitle(md: string, fallback: string): string {
  const lines = md.split(/\r?\n/);
  const titleLine = lines.find((l) => l.trim().startsWith("# "));
  if (!titleLine) return fallback;
  return stripMarkdown(titleLine.replace(/^#\s+/, ""));
}

function extractSummary(md: string, maxLen = 280): string {
  const lines = md.split(/\r?\n/);
  let started = false;
  const parts: string[] = [];

  for (const line of lines) {
    const t = line.trim();
    if (!started) {
      if (t.startsWith("# ")) {
        started = true;
      }
      continue;
    }
    if (!t) {
      if (parts.length > 0) break;
      continue;
    }
    if (t.startsWith("*") || t.startsWith("---") || t.startsWith("***")) continue;
    if (t.startsWith("## ")) break;
    parts.push(t);
    if (parts.join(" ").length >= maxLen) break;
  }

  const summary = stripMarkdown(parts.join(" "));
  if (summary.length <= maxLen) return summary;
  return summary.slice(0, maxLen - 1).trimEnd() + "…";
}

const entries = await getCollection("specs");
const businessEntries = entries
  .filter((e) => e.id.startsWith("business/"))
  .sort((a, b) => a.id.localeCompare(b.id));

const preferredOrder = ["business/model.md", "business/plan.md"]; // adjust anytime
businessEntries.sort((a, b) => {
  const ai = preferredOrder.indexOf(a.id);
  const bi = preferredOrder.indexOf(b.id);
  if (ai !== -1 || bi !== -1) return (ai === -1 ? 999 : ai) - (bi === -1 ? 999 : bi);
  return a.id.localeCompare(b.id);
});

const docs = await Promise.all(
  businessEntries.map(async (entry) => {
    const srcPath = path.resolve(process.cwd(), "..", "specs", entry.id);
    const md = await readFile(srcPath, "utf-8");
    const slug = entry.id.replace(/^business\//, "").replace(/\.md$/i, "");
    const title = extractTitle(md, slug);
    const summary = extractSummary(md);
    return {
      title,
      href: `/admin/business/${slug}`,
      source: `specs/${entry.id}`,
      summary,
    };
  })
);
---

<BaseLayout title="Admin — Business">
  <div class="prose" style="max-width: 100%;">
    <h1>Business documents</h1>
    <p>Reading order and summary for each document in the Dogology business package.</p>

    <ol class="doc-list">
      {docs.map((doc) => (
        <li class="doc-item">
          <h2>
            <a href={doc.href}>{doc.title}</a>
          </h2>
          <div class="small">{doc.source}</div>
          <p>{doc.summary}</p>
        </li>
      ))}
    </ol>
  </div>
</BaseLayout>

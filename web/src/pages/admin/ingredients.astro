---
import BaseLayout from "../../layouts/BaseLayout.astro";
import { loadIngredientDb, loadWeeklyMealPlan } from "../../lib/loaders";

const db = await loadIngredientDb();
const ingredients = db.ingredients;

/* ── Recipe ingredient usage (local JSON — always available) ── */
const mealPlan = await loadWeeklyMealPlan();
const recipeUsage = new Map<string, number>();
for (const recipe of mealPlan.recipes) {
  for (const ing of recipe.ingredients) {
    recipeUsage.set(ing.ingredient_id, (recipeUsage.get(ing.ingredient_id) ?? 0) + 1);
  }
}

/* ── Build rows (FDC columns filled client-side) ─────── */
const rows = ingredients.map((ing) => ({
  id: ing.id,
  name: ing.name,
  category: ing.category,
  tier: ing.tier,
  inRecipes: recipeUsage.get(ing.id) ?? 0,
}));

const inRecipeCount = rows.filter((r) => r.inRecipes > 0).length;

// Group by category for section headers
const categories = [...new Set(rows.map((r) => r.category))];

const buildTimeKey = import.meta.env.FDC_API_KEY ?? "";

/* Supabase public credentials (anon key — safe for client, RLS-enforced) */
const supabaseUrl = import.meta.env.SUPABASE_URL ?? "https://zrlplilzpwsxqxskeoqc.supabase.co";
const supabaseAnonKey = import.meta.env.SUPABASE_ANON_KEY ?? "eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6InpybHBsaWx6cHdzeHF4c2tlb3FjIiwicm9sZSI6ImFub24iLCJpYXQiOjE3NzEzNjkzNDYsImV4cCI6MjA4Njk0NTM0Nn0.NuwLsAdj1TKsPMWadJjhVd_F97gBuntcsiNCtwypbG0";
---

<BaseLayout title="Admin — FDC Mapping" container="lg">
  <div class="prose" id="fdc-root"
       data-supabase-url={supabaseUrl}
       data-supabase-anon-key={supabaseAnonKey}>
    <h1>FDC Ingredient Mapping</h1>
    <p class="small">Map ingredients to USDA FoodData Central IDs for nutrient data extraction.</p>

    <div class="fdc-toolbar">
      <label>
        FDC API Key
        <input type="password" id="fdc-api-key" placeholder="Enter your FDC API key" autocomplete="off" data-default-key={buildTimeKey} />
      </label>
      <button class="button" id="fdc-import-btn" type="button">Import JSON</button>
      <button class="button" id="fdc-export-btn" type="button">Export JSON</button>
      <input type="file" id="fdc-import-file" accept=".json" hidden />
    </div>

    <p class="fdc-stats">
      <strong id="fdc-mapped-count">…</strong> / {rows.length} mapped to FDC
      &nbsp;&middot;&nbsp;
      <strong>{inRecipeCount}</strong> used in recipes
    </p>

    {categories.map((cat) => {
      const catRows = rows.filter((r) => r.category === cat);
      const catLabel = cat.replace(/_/g, " ").replace(/\b\w/g, (c: string) => c.toUpperCase());
      return (
        <details class="plan-phase" open>
          <summary class="plan-phase__summary">
            <strong>{catLabel}</strong>
            <span class="small" style="margin-left: var(--space-2); color: var(--color-muted);">
              (<span class="cat-mapped">0</span>/{catRows.length})
            </span>
          </summary>
          <div class="fdc-table-wrap" style="border:none; border-radius:0;">
            <table class="fdc-table">
              <thead>
                <tr>
                  <th>Name</th>
                  <th>Tier</th>
                  <th class="num-col">Recipes</th>
                  <th>FDC ID</th>
                  <th>FDC Description</th>
                  <th>Type</th>
                  <th></th>
                </tr>
              </thead>
              <tbody>
                {catRows.map((row) => (
                  <tr
                    data-ingredient-id={row.id}
                  >
                    <td>
                      <span class="ing-name">{row.name}</span>
                    </td>
                    <td><span class="tier-badge">{row.tier}</span></td>
                    <td class="num-col">
                      {row.inRecipes > 0 ? (
                        <span class="recipe-count">{row.inRecipes}</span>
                      ) : (
                        <span class="fdc-unmapped">—</span>
                      )}
                    </td>
                    <td class="fdc-id-cell">
                      <span class="fdc-loading">…</span>
                    </td>
                    <td class="fdc-desc-cell"></td>
                    <td class="fdc-type-cell"></td>
                    <td class="fdc-action-cell">
                      <button
                        class="fdc-search-btn"
                        type="button"
                        data-ingredient-id={row.id}
                        data-ingredient-name={row.name}
                      >
                        Search
                      </button>
                      <button
                        class="fdc-clear-btn"
                        type="button"
                        data-ingredient-id={row.id}
                        style="display:none"
                      >
                        ✕
                      </button>
                    </td>
                  </tr>
                ))}
              </tbody>
            </table>
          </div>
        </details>
      );
    })}
  </div>

  {/* Search dialog */}
  <dialog id="fdc-search-dialog" class="fdc-dialog">
    <h3 id="fdc-dialog-title">Search FDC</h3>
    <div class="fdc-dialog-row">
      <input type="text" id="fdc-search-input" placeholder="Search FoodData Central..." />
      <button class="button" id="fdc-do-search" type="button">Search</button>
    </div>
    <div class="fdc-dialog-divider"><span>or enter FDC ID directly</span></div>
    <div class="fdc-dialog-row">
      <input type="number" id="fdc-id-input" placeholder="e.g. 170567" min="1" step="1" />
      <button class="button" id="fdc-do-lookup" type="button">Look up</button>
    </div>
    <div id="fdc-search-results"></div>
    <div style="margin-top: var(--space-4); text-align: right;">
      <button class="button" id="fdc-dialog-close" type="button">Close</button>
    </div>
  </dialog>
</BaseLayout>

<style>
  .num-col {
    text-align: center;
    white-space: nowrap;
  }
  .recipe-count {
    display: inline-block;
    min-width: 1.5em;
    text-align: center;
    font-size: var(--text-micro);
    font-weight: 600;
    background: var(--color-code-surface);
    border-radius: var(--radius-sm);
    padding: 0.1em 0.4em;
  }
  .ing-link {
    font-weight: 600;
    color: var(--color-link);
    text-decoration: none;
  }
  .ing-link:hover {
    text-decoration: underline;
  }
  .fdc-mapped {
    color: var(--color-link);
    text-decoration: none;
    font-variant-numeric: tabular-nums;
  }
  .fdc-mapped:hover {
    text-decoration: underline;
  }
  .fdc-dialog-divider {
    text-align: center;
    margin: var(--space-3) 0;
    font-size: var(--text-sm);
    color: var(--color-muted);
    display: flex;
    align-items: center;
    gap: var(--space-3);
  }
  .fdc-dialog-divider::before,
  .fdc-dialog-divider::after {
    content: "";
    flex: 1;
    height: 1px;
    background: var(--color-border);
  }
  #fdc-id-input {
    max-width: 10em;
    font-variant-numeric: tabular-nums;
  }
  .fdc-result--highlight {
    border: 2px solid var(--color-link);
    border-radius: var(--radius-md);
  }
</style>

<script>
  document.addEventListener("astro:page-load", () => {
  const root = document.getElementById("fdc-root");
  if (!root) return; // Not on admin ingredients page

  type MappingEntry = {
    fdc_id: number;
    fdc_description: string;
    data_type: string;
    mapped_at: string;
  };

  const mappings = new Map<string, MappingEntry>();
  const SUPABASE_URL = root.dataset.supabaseUrl ?? "";
  const SUPABASE_ANON_KEY = root.dataset.supabaseAnonKey ?? "";

  // --- Fetch FDC mappings from Supabase at page load ---
  async function fetchFdcMappings() {
    if (!SUPABASE_URL || !SUPABASE_ANON_KEY) {
      console.warn("[fdc] Supabase config not available");
      clearLoadingIndicators();
      return;
    }

    const url = `${SUPABASE_URL}/rest/v1/fdc_mappings?select=ingredient_id,fdc_id,fdc_description,data_type,mapped_at,updated_at&order=ingredient_id`;
    try {
      const res = await fetch(url, {
        headers: {
          apikey: SUPABASE_ANON_KEY,
          Authorization: `Bearer ${SUPABASE_ANON_KEY}`,
          Accept: "application/json",
        },
      });
      if (!res.ok) throw new Error(`HTTP ${res.status}`);
      const rows: MappingEntry[] = await res.json();

      for (const m of rows) {
        mappings.set((m as any).ingredient_id, {
          fdc_id: m.fdc_id,
          fdc_description: m.fdc_description,
          data_type: m.data_type,
          mapped_at: m.mapped_at ?? "",
        });
      }

      // Populate all table rows with FDC data
      document.querySelectorAll<HTMLTableRowElement>("tr[data-ingredient-id]").forEach((row) => {
        const id = row.dataset.ingredientId!;
        const entry = mappings.get(id) ?? null;
        rerenderRow(id, entry);
      });

      updateStats();
    } catch (err) {
      console.error("[fdc] Failed to load mappings:", err);
      clearLoadingIndicators();
    }
  }

  function clearLoadingIndicators() {
    document.querySelectorAll(".fdc-loading").forEach((el) => {
      el.textContent = "—";
      el.className = "fdc-unmapped";
    });
    const countEl = document.getElementById("fdc-mapped-count");
    if (countEl) countEl.textContent = "0";
  }

  // --- API Key ---
  const KEY_STORAGE = "dogology:fdc_api_key";
  const keyInput = document.getElementById("fdc-api-key") as HTMLInputElement;
  const defaultKey = keyInput.dataset.defaultKey ?? "";
  keyInput.value = localStorage.getItem(KEY_STORAGE) || defaultKey;
  if (!localStorage.getItem(KEY_STORAGE) && defaultKey) {
    localStorage.setItem(KEY_STORAGE, defaultKey);
  }
  keyInput.addEventListener("input", () => {
    localStorage.setItem(KEY_STORAGE, keyInput.value.trim());
  });

  function getApiKey(): string {
    return localStorage.getItem(KEY_STORAGE)?.trim() || defaultKey;
  }

  // --- Search dialog ---
  const dialog = document.getElementById(
    "fdc-search-dialog",
  ) as HTMLDialogElement;
  const dialogTitle = document.getElementById(
    "fdc-dialog-title",
  ) as HTMLElement;
  const searchInput = document.getElementById(
    "fdc-search-input",
  ) as HTMLInputElement;
  const resultsEl = document.getElementById(
    "fdc-search-results",
  ) as HTMLDivElement;
  let activeIngredientId = "";

  // Open dialog from search buttons
  document
    .querySelectorAll<HTMLButtonElement>(".fdc-search-btn")
    .forEach((btn) => {
      btn.addEventListener("click", () => {
        activeIngredientId = btn.dataset.ingredientId!;
        const name = btn.dataset.ingredientName!;
        dialogTitle.textContent = `Search FDC — ${name}`;
        searchInput.value = name;
        resultsEl.innerHTML = "";
        dialog.showModal();
      });
    });

  // Close dialog
  document.getElementById("fdc-dialog-close")!.addEventListener("click", () => {
    dialog.close();
  });

  // Close on backdrop click
  dialog.addEventListener("click", (e) => {
    if (e.target === dialog) dialog.close();
  });

  const idInput = document.getElementById("fdc-id-input") as HTMLInputElement;

  // Enter key in search input
  searchInput.addEventListener("keydown", (e) => {
    if (e.key === "Enter") {
      e.preventDefault();
      doSearch();
    }
  });

  // Enter key in ID input
  idInput.addEventListener("keydown", (e) => {
    if (e.key === "Enter") {
      e.preventDefault();
      doLookup();
    }
  });

  // Search button
  document.getElementById("fdc-do-search")!.addEventListener("click", doSearch);

  // Lookup button
  document.getElementById("fdc-do-lookup")!.addEventListener("click", doLookup);

  async function doLookup() {
    const key = getApiKey();
    if (!key) {
      alert("Enter your FDC API key first.");
      return;
    }
    const fdcId = parseInt(idInput.value.trim(), 10);
    if (!fdcId || fdcId < 1) {
      alert("Enter a valid FDC ID (positive integer).");
      return;
    }

    resultsEl.innerHTML = "<p>Looking up FDC ID " + fdcId + "...</p>";

    try {
      const url = `https://api.nal.usda.gov/fdc/v1/food/${fdcId}?api_key=${key}`;
      const res = await fetch(url);
      if (res.status === 404) {
        resultsEl.innerHTML = "<p>No food found with FDC ID " + fdcId + ".</p>";
        return;
      }
      if (!res.ok) throw new Error(`HTTP ${res.status}`);
      const f = await res.json();

      const desc = f.description ?? "Unknown";
      const dataType = f.dataType ?? "";
      const category = f.foodCategory?.description ?? f.foodCategory ?? "";

      resultsEl.innerHTML = `
        <div class="fdc-result fdc-result--highlight">
          <div class="fdc-result-info">
            <div class="fdc-result-desc">${escapeHtml(desc)}</div>
            <div class="fdc-result-meta">FDC ${fdcId} · ${escapeHtml(dataType)}${category ? ` · ${escapeHtml(category)}` : ""}</div>
          </div>
          <button class="fdc-assign-btn"
                  data-fdc-id="${fdcId}"
                  data-fdc-desc="${escapeAttr(desc)}"
                  data-fdc-type="${escapeAttr(dataType)}">
            Assign
          </button>
        </div>
      `;

      resultsEl.querySelector<HTMLButtonElement>(".fdc-assign-btn")!.addEventListener("click", (e) => {
        const btn = e.currentTarget as HTMLButtonElement;
        assignMapping(activeIngredientId, {
          fdc_id: Number(btn.dataset.fdcId),
          fdc_description: btn.dataset.fdcDesc!,
          data_type: btn.dataset.fdcType!,
          mapped_at: new Date().toISOString(),
        });
        dialog.close();
      });
    } catch (err) {
      resultsEl.innerHTML = `<p style="color:red;">Error: ${err}</p>`;
    }
  }

  async function doSearch() {
    const key = getApiKey();
    if (!key) {
      alert("Enter your FDC API key first.");
      return;
    }
    const query = searchInput.value.trim();
    if (!query) return;

    resultsEl.innerHTML = "<p>Searching...</p>";

    try {
      const url = `https://api.nal.usda.gov/fdc/v1/foods/search?api_key=${key}&query=${encodeURIComponent(query)}&pageSize=25&dataType=SR%20Legacy,Foundation`;
      const res = await fetch(url);
      if (!res.ok) throw new Error(`HTTP ${res.status}`);
      const data = await res.json();

      if (!data.foods?.length) {
        resultsEl.innerHTML = "<p>No results found.</p>";
        return;
      }

      resultsEl.innerHTML = data.foods
        .map(
          (f: {
            fdcId: number;
            description: string;
            dataType: string;
            foodCategory?: string;
          }) => `
        <div class="fdc-result">
          <div class="fdc-result-info">
            <div class="fdc-result-desc">${escapeHtml(f.description)}</div>
            <div class="fdc-result-meta">FDC ${f.fdcId} · ${escapeHtml(f.dataType)}${f.foodCategory ? ` · ${escapeHtml(f.foodCategory)}` : ""}</div>
          </div>
          <button class="fdc-assign-btn"
                  data-fdc-id="${f.fdcId}"
                  data-fdc-desc="${escapeAttr(f.description)}"
                  data-fdc-type="${escapeAttr(f.dataType)}">
            Assign
          </button>
        </div>
      `,
        )
        .join("");

      // Bind assign buttons
      resultsEl
        .querySelectorAll<HTMLButtonElement>(".fdc-assign-btn")
        .forEach((btn) => {
          btn.addEventListener("click", () => {
            assignMapping(activeIngredientId, {
              fdc_id: Number(btn.dataset.fdcId),
              fdc_description: btn.dataset.fdcDesc!,
              data_type: btn.dataset.fdcType!,
              mapped_at: new Date().toISOString(),
            });
            dialog.close();
          });
        });
    } catch (err) {
      resultsEl.innerHTML = `<p style="color:red;">Error: ${err}</p>`;
    }
  }

  // --- Clear (unmap) buttons ---
  document
    .querySelectorAll<HTMLButtonElement>(".fdc-clear-btn")
    .forEach((btn) => {
      btn.addEventListener("click", () => {
        clearMapping(btn.dataset.ingredientId!);
      });
    });

  // --- Assign + re-render row ---
  function assignMapping(ingredientId: string, entry: MappingEntry) {
    mappings.set(ingredientId, entry);
    rerenderRow(ingredientId, entry);
    updateStats();
  }

  function clearMapping(ingredientId: string) {
    mappings.delete(ingredientId);
    rerenderRow(ingredientId, null);
    updateStats();
  }

  function rerenderRow(ingredientId: string, entry: MappingEntry | null) {
    const row = document.querySelector(
      `tr[data-ingredient-id="${ingredientId}"]`,
    );
    if (!row) return;

    // Update name cell: add/remove link
    const nameCell = row.querySelector("td:first-child");
    if (nameCell) {
      const name = nameCell.textContent?.trim() ?? ingredientId;
      if (entry) {
        nameCell.innerHTML = `<a href="/ingredients/${ingredientId}" class="ing-link">${escapeHtml(name)}</a>`;
      } else {
        nameCell.innerHTML = `<span class="ing-name">${escapeHtml(name)}</span>`;
      }
    }

    const idCell = row.querySelector(".fdc-id-cell");
    if (idCell) {
      idCell.innerHTML = entry
        ? `<a href="https://fdc.nal.usda.gov/food-details/${entry.fdc_id}/nutrients" target="_blank" rel="noopener" class="fdc-mapped">${entry.fdc_id}</a>`
        : `<span class="fdc-unmapped">—</span>`;
    }
    const descCell = row.querySelector(".fdc-desc-cell");
    if (descCell) descCell.textContent = entry?.fdc_description ?? "";
    const typeCell = row.querySelector(".fdc-type-cell");
    if (typeCell) typeCell.textContent = entry?.data_type ?? "";

    // Show / hide clear button
    const clearBtn = row.querySelector<HTMLButtonElement>(".fdc-clear-btn");
    if (clearBtn) clearBtn.style.display = entry ? "" : "none";
  }

  // --- Export ---
  document.getElementById("fdc-export-btn")!.addEventListener("click", () => {
    const payload = {
      version: "1.0",
      updated_at: new Date().toISOString(),
      mappings: Array.from(mappings.entries()).map(([id, e]) => ({
        ingredient_id: id,
        fdc_id: e.fdc_id,
        fdc_description: e.fdc_description,
        data_type: e.data_type,
      })),
    };
    const blob = new Blob([JSON.stringify(payload, null, 2) + "\n"], {
      type: "application/json",
    });
    const a = document.createElement("a");
    a.href = URL.createObjectURL(blob);
    a.download = "fdc_mapping.json";
    a.click();
    URL.revokeObjectURL(a.href);
  });

  // --- Import ---
  const importFile = document.getElementById(
    "fdc-import-file",
  ) as HTMLInputElement;
  document
    .getElementById("fdc-import-btn")!
    .addEventListener("click", () => importFile.click());

  importFile.addEventListener("change", async () => {
    const file = importFile.files?.[0];
    if (!file) return;
    try {
      const text = await file.text();
      const data = JSON.parse(text);
      let count = 0;
      for (const m of data.mappings ?? []) {
        if (m.ingredient_id && m.fdc_id) {
          assignMapping(m.ingredient_id, {
            fdc_id: m.fdc_id,
            fdc_description: m.fdc_description ?? "",
            data_type: m.data_type ?? "",
            mapped_at: m.mapped_at ?? "",
          });
          count++;
        }
      }
      alert(`Imported ${count} mapping(s).`);
    } catch (err) {
      alert(`Import failed: ${err}`);
    }
    importFile.value = "";
  });

  // --- Stats ---
  function updateStats() {
    const el = document.getElementById("fdc-mapped-count");
    if (el) el.textContent = String(mappings.size);

    // Update per-category counts in <summary> badges
    document
      .querySelectorAll<HTMLDetailsElement>("details.plan-phase")
      .forEach((details) => {
        const rows = details.querySelectorAll<HTMLTableRowElement>("tr[data-ingredient-id]");
        const total = rows.length;
        let mapped = 0;
        rows.forEach((row) => {
          if (mappings.has(row.dataset.ingredientId!)) mapped++;
        });
        const badge = details.querySelector(".cat-mapped");
        if (badge) badge.textContent = String(mapped);
      });
  }

  // --- Helpers ---
  function escapeHtml(s: string): string {
    const div = document.createElement("div");
    div.textContent = s;
    return div.innerHTML;
  }

  function escapeAttr(s: string): string {
    return s.replace(/&/g, "&amp;").replace(/"/g, "&quot;").replace(/</g, "&lt;").replace(/>/g, "&gt;");
  }

  // --- Go! ---
  fetchFdcMappings();
  }); // end astro:page-load
</script>

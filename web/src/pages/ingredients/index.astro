---
import BaseLayout from "../../layouts/BaseLayout.astro";
import { loadIngredientDb } from "../../lib/loaders";
import { loadFdcNutrientMap } from "../../lib/supabaseFdc";
import type { Ingredient } from "../../lib/schemas";
import type { FdcNutrient } from "../../lib/supabaseFdc";

function titleCaseCategory(category: string): string {
  return category
    .split("_")
    .filter(Boolean)
    .map((w) => w.charAt(0).toUpperCase() + w.slice(1))
    .join(" ");
}

function stableSort<T>(items: T[], toKey: (x: T) => string): T[] {
  return [...items].sort((a, b) => toKey(a).localeCompare(toKey(b)));
}

function fmt(v: number | null | undefined, decimals = 1): string {
  if (v == null) return "—";
  return v.toFixed(decimals);
}

const db = await loadIngredientDb();
const fdcMap = await loadFdcNutrientMap();

const tierLabels = db.metadata?.availability_tiers ?? {};

type IngRow = Ingredient & { fdc: FdcNutrient | null };

const byCategory = new Map<string, IngRow[]>();
for (const ing of db.ingredients ?? []) {
  const category = ing.category ?? "uncategorized";
  const arr = byCategory.get(category) ?? [];
  arr.push({ ...ing, fdc: fdcMap.get(ing.id) ?? null });
  byCategory.set(category, arr);
}

const categories = stableSort(Array.from(byCategory.keys()), (c) => c);
const categorySections = categories.map((c) => ({
  key: c,
  label: titleCaseCategory(c),
  items: stableSort(byCategory.get(c) ?? [], (i) => i.name ?? i.id),
}));

const totalIngredients = db.ingredients?.length ?? 0;
const totalMapped = [...fdcMap.keys()].length;
---

<BaseLayout title="Ingredients" description="Browse the full canine ingredient database with USDA FoodData Central nutrient profiles.">

  <div class="page-header">
    <div class="page-header__top">
      <p class="section-label">Database &middot; {totalIngredients} ingredients &middot; {totalMapped} with FDC data</p>
      <button class="button no-print" type="button" onclick="window.print()">Print</button>
    </div>
    <h1 class="section-headline" style="font-size:var(--text-3xl);">Ingredient Database</h1>
    <p class="page-sub">Complete nutrient profiles from the USDA FoodData Central database. All values per 100 g edible portion.</p>
  </div>

  <!-- Category jump nav -->
  <nav class="ing-jumps" aria-label="Jump to category">
    {categorySections.map((c) => (
      <a href={`#${c.key}`} class="ing-jump-link">{c.label} <span class="ing-jump-count">{c.items.length}</span></a>
    ))}
  </nav>

  <!-- Category sections -->
  {categorySections.map((c) => (
    <section id={c.key} class="ing-section">
      <h2 class="ing-section__title">{c.label} <span class="ing-section__count">{c.items.length}</span></h2>
      <div class="ing-table-wrap">
        <table class="ing-table ing-table--nutrients">
          <thead>
            <tr>
              <th>Ingredient</th>
              <th>Tier</th>
              <th class="num">kcal</th>
              <th class="num">Protein</th>
              <th class="num">Fat</th>
              <th class="num">Carb</th>
              <th class="num">Fiber</th>
              <th class="num">Ca</th>
              <th class="num">P</th>
              <th class="num">Fe</th>
              <th class="num">Zn</th>
              <th>FDC</th>
            </tr>
          </thead>
          <tbody>
            {c.items.map((ing) => {
              const n = ing.fdc;
              const tierText = tierLabels[ing.tier] ? `${ing.tier}` : ing.tier;
              return (
                <tr>
                  <td>
                    {n ? (
                      <a href={`/ingredients/${ing.id}`} class="ing-link">{ing.name}</a>
                    ) : (
                      <span class="ing-name">{ing.name}</span>
                    )}
                    {ing.notes && <div class="ing-meta">{ing.notes}</div>}
                  </td>
                  <td><span class="tier-badge">{tierText}</span></td>
                  <td class="num">{fmt(n?.energy_kcal, 0)}</td>
                  <td class="num">{fmt(n?.protein_g)}</td>
                  <td class="num">{fmt(n?.fat_g)}</td>
                  <td class="num">{fmt(n?.carbohydrate_g)}</td>
                  <td class="num">{fmt(n?.fiber_g)}</td>
                  <td class="num">{fmt(n?.calcium_mg)}</td>
                  <td class="num">{fmt(n?.phosphorus_mg)}</td>
                  <td class="num">{fmt(n?.iron_mg)}</td>
                  <td class="num">{fmt(n?.zinc_mg)}</td>
                  <td class="fdc-ref">
                    {n ? (
                      <a href={`https://fdc.nal.usda.gov/food-details/${n.fdc_id}/nutrients`}
                         target="_blank" rel="noopener" title={n.fdc_description}>
                        {n.fdc_id}
                      </a>
                    ) : (
                      <span class="fdc-unmapped">—</span>
                    )}
                  </td>
                </tr>
              );
            })}
          </tbody>
        </table>
      </div>
    </section>
  ))}

</BaseLayout>

<style>
  .ing-table--nutrients th.num,
  .ing-table--nutrients td.num {
    text-align: right;
    font-variant-numeric: tabular-nums;
    white-space: nowrap;
    min-width: 4ch;
  }
  .ing-link {
    font-weight: 600;
    color: var(--color-link);
    text-decoration: none;
  }
  .ing-link:hover {
    text-decoration: underline;
  }
  .fdc-ref {
    font-size: var(--text-micro);
    color: var(--color-muted);
    white-space: nowrap;
  }
  .fdc-ref a {
    color: var(--color-muted);
  }
  .fdc-ref a:hover {
    color: var(--color-link);
  }
</style>

---
import BaseLayout from "../layouts/BaseLayout.astro";
import { readFile } from "node:fs/promises";
import path from "node:path";

const jsonPath = path.resolve(process.cwd(), "..", "specs", "recipes", "weekly_meal_plan.json");
const raw = await readFile(jsonPath, "utf-8");
const plan = JSON.parse(raw);

const recipes: any[] = plan.recipes ?? [];
const sizing: Record<string, any> = plan.metadata?.size_scaling ?? {};
const weeklyPlan: any = plan.weekly_plan ?? {};

// Collect unique filter values
const proteins = [...new Set(recipes.map((r: any) => r.tags?.protein_type).filter(Boolean))].sort();
const tiers = [...new Set(recipes.map((r: any) => r.tags?.tier).filter(Boolean))].sort();

function labelify(s: string): string {
  return s.replace(/_/g, " ").replace(/\b\w/g, (c) => c.toUpperCase());
}
---

<BaseLayout
  title="Recipes"
  description="14 complete canine meal recipes with size-scaled ingredient amounts, nutrient estimates, and a 7-day rotation plan."
>
  <div class="page-header">
    <p class="section-label">Meal Library</p>
    <h1 class="section-headline">Recipes</h1>
    <p class="page-sub">{plan.metadata?.description ?? ""}</p>
  </div>

  <!-- ── Filter bar ── -->
  <div class="filter-bar" id="filter-bar">
    <!-- Size selector -->
    <fieldset class="filter-group">
      <legend class="filter-label">Dog size</legend>
      <div class="pill-row" id="size-picker">
        {Object.entries(sizing).map(([key, val]: [string, any]) => (
          <button
            type="button"
            class:list={["pill", { "pill--active": key === "medium" }]}
            data-size={key}
          >
            {val.label}
            <span class="pill-sub">{val.weight_kg} kg · {val.approx_mer_kcal} kcal/day</span>
          </button>
        ))}
      </div>
    </fieldset>

    <!-- Protein type -->
    <fieldset class="filter-group">
      <legend class="filter-label">Protein</legend>
      <div class="pill-row" id="protein-picker">
        <button type="button" class="pill pill--active" data-protein="all">All</button>
        {proteins.map((p: any) => (
          <button type="button" class="pill" data-protein={p}>
            {labelify(p)}
          </button>
        ))}
      </div>
    </fieldset>

    <!-- Tier -->
    <fieldset class="filter-group">
      <legend class="filter-label">Tier</legend>
      <div class="pill-row" id="tier-picker">
        <button type="button" class="pill pill--active" data-tier="all">All</button>
        {tiers.map((t: any) => (
          <button type="button" class="pill" data-tier={t}>
            {t === "T2" ? "T2 · Specialty" : "T1 · Standard"}
          </button>
        ))}
      </div>
    </fieldset>

    <!-- Max prep time -->
    <fieldset class="filter-group">
      <legend class="filter-label">Max prep time</legend>
      <div class="pill-row" id="prep-picker">
        <button type="button" class="pill pill--active" data-prep="0">Any</button>
        <button type="button" class="pill" data-prep="20">≤ 20 min</button>
        <button type="button" class="pill" data-prep="30">≤ 30 min</button>
        <button type="button" class="pill" data-prep="40">≤ 40 min</button>
      </div>
    </fieldset>
  </div>

  <!-- ── Results count ── -->
  <p class="results-count" id="results-count"></p>

  <!-- ── Recipe grid ── -->
  <div class="recipe-grid" id="recipe-grid">
    {recipes.map((r: any) => {
      const prep = r.tags?.prep_time_min ?? 0;
      const protein = r.tags?.protein_type ?? "";
      const tier = r.tags?.tier ?? "";
      const carb = r.tags?.primary_carb ?? "";
      const veggie = r.tags?.primary_veggie ?? "";
      return (
        <article
          class="recipe-card"
          data-recipe-id={r.id}
          data-protein={protein}
          data-tier={tier}
          data-prep={prep}
        >
          <div class="recipe-card__head">
            <div class="recipe-card__badges">
              <span class:list={["badge", tier === "T2" ? "badge--t2" : "badge--t1"]}>{tier}</span>
              <span class="badge badge--time">⏱ {prep} min</span>
            </div>
            <h2 class="recipe-card__name">{r.name}</h2>
            <p class="recipe-card__tags">
              <span class="tag tag--protein">{labelify(protein)}</span>
              <span class="tag tag--carb">{labelify(carb)}</span>
              <span class="tag tag--veggie">{labelify(veggie)}</span>
            </p>
            <p class="recipe-card__overview">{r.overview}</p>
          </div>

          <!-- Ingredient table — amounts update via JS -->
          <div class="recipe-card__section">
            <h3 class="recipe-card__section-title">Ingredients</h3>
            <table class="ingredient-table">
              <thead>
                <tr>
                  <th>Ingredient</th>
                  <th class="amount-col">Amount</th>
                  <th>Prep</th>
                </tr>
              </thead>
              <tbody>
                {r.ingredients.map((ing: any) => (
                  <tr>
                    <td>{ing.name}</td>
                    <td
                      class="amount-col"
                      data-base-g={ing.base_g ?? null}
                      data-unit={ing.unit}
                    >
                      {ing.base_g != null
                        ? `${Math.round(ing.base_g * 0.95)} ${ing.unit}`
                        : ing.prep}
                    </td>
                    <td class="prep-col">{ing.base_g != null ? ing.prep : ""}</td>
                  </tr>
                ))}
              </tbody>
            </table>
          </div>

          <!-- Nutrient summary -->
          <div class="recipe-card__section">
            <h3 class="recipe-card__section-title">Per 1,000 kcal</h3>
            <div class="nutrient-row">
              <div class="nutrient-stat">
                <span class="nutrient-val">{r.per_1000kcal_estimate?.protein_g}g</span>
                <span class="nutrient-lbl">Protein</span>
              </div>
              <div class="nutrient-stat">
                <span class="nutrient-val">{r.per_1000kcal_estimate?.fat_g}g</span>
                <span class="nutrient-lbl">Fat</span>
              </div>
              <div class="nutrient-stat">
                <span class="nutrient-val">{r.per_1000kcal_estimate?.fiber_g}g</span>
                <span class="nutrient-lbl">Fiber</span>
              </div>
              <div class="nutrient-stat">
                <span class="nutrient-val">{r.per_1000kcal_estimate?.ca_p_ratio}</span>
                <span class="nutrient-lbl">Ca:P</span>
              </div>
              <div class="nutrient-stat">
                <span class="nutrient-val">{r.per_1000kcal_estimate?.calcium_mg}mg</span>
                <span class="nutrient-lbl">Calcium</span>
              </div>
            </div>
          </div>

          <!-- Dimension chips -->
          {r.tags?.dimensions_covered?.length > 0 && (
            <div class="recipe-card__section">
              <p class="dim-chips">
                {r.tags.dimensions_covered.map((d: string) => (
                  <span class="dim-chip">{d}</span>
                ))}
              </p>
            </div>
          )}

          <!-- Collapsible instructions -->
          <details class="recipe-card__instructions">
            <summary>Instructions</summary>
            <ol class="instruction-list">
              {r.instructions.map((step: string) => (
                <li>{step}</li>
              ))}
            </ol>
          </details>
        </article>
      );
    })}
  </div>

  <!-- ── Weekly plan ── -->
  <section class="weekly-plan-section">
    <h2 class="section-headline" style="font-size:var(--text-2xl);margin-bottom:1rem;">7-Day Rotation Plan</h2>
    <p class="page-sub" style="margin-bottom:1.5rem;">{weeklyPlan.description}</p>
    <div class="week-grid">
      {weeklyPlan.days?.map((day: any) => {
        const am = recipes.find((r: any) => r.id === day.am?.recipe_id);
        const pm = recipes.find((r: any) => r.id === day.pm?.recipe_id);
        return (
          <div class="week-cell">
            <div class="week-cell__day">{day.label}</div>
            {am && (
              <a class="week-cell__meal week-cell__meal--am" href={`#${am.id}`} data-week-link>
                <span class="week-meal-time">AM</span>
                {am.name}
              </a>
            )}
            {pm && (
              <a class="week-cell__meal week-cell__meal--pm" href={`#${pm.id}`} data-week-link>
                <span class="week-meal-time">PM</span>
                {pm.name}
              </a>
            )}
          </div>
        );
      })}
    </div>
  </section>
</BaseLayout>

<script define:vars={{ sizing }}>
  // ── State ──
  let activeSize = "medium";
  let activeProtein = "all";
  let activeTier = "all";
  let activeMaxPrep = 0; // 0 = any

  // ── DOM refs ──
  const grid = document.getElementById("recipe-grid");
  const cards = Array.from(grid.querySelectorAll(".recipe-card"));
  const countEl = document.getElementById("results-count");

  // ── Size scaling ──
  function applySize(sizeKey) {
    const factor = sizing[sizeKey]?.factor ?? 0.95;
    for (const cell of grid.querySelectorAll("td[data-base-g]")) {
      const base = parseFloat(cell.dataset.baseG);
      if (!isNaN(base)) {
        const unit = cell.dataset.unit ?? "g";
        cell.textContent = `${Math.round(base * factor)} ${unit}`;
      }
    }
  }

  // ── Filtering ──
  function applyFilters() {
    let visible = 0;
    for (const card of cards) {
      const protein = card.dataset.protein ?? "";
      const tier = card.dataset.tier ?? "";
      const prep = parseInt(card.dataset.prep ?? "0", 10);

      const proteinOk = activeProtein === "all" || protein === activeProtein;
      const tierOk = activeTier === "all" || tier === activeTier;
      const prepOk = activeMaxPrep === 0 || prep <= activeMaxPrep;

      const show = proteinOk && tierOk && prepOk;
      card.hidden = !show;
      if (show) visible++;
    }
    countEl.textContent = `Showing ${visible} of ${cards.length} recipes`;
  }

  // ── Pill row helper ──
  function bindPills(containerId, onSelect) {
    const container = document.getElementById(containerId);
    container.addEventListener("click", (e) => {
      const btn = e.target.closest("button[data-" + containerId.replace("-picker", "") + "]");
      if (!btn) return;
      for (const p of container.querySelectorAll(".pill")) p.classList.remove("pill--active");
      btn.classList.add("pill--active");
      onSelect(btn);
    });
  }

  // ── Bind size ──
  const sizePicker = document.getElementById("size-picker");
  sizePicker.addEventListener("click", (e) => {
    const btn = e.target.closest("button[data-size]");
    if (!btn) return;
    for (const p of sizePicker.querySelectorAll(".pill")) p.classList.remove("pill--active");
    btn.classList.add("pill--active");
    activeSize = btn.dataset.size;
    applySize(activeSize);
  });

  // ── Bind protein ──
  const proteinPicker = document.getElementById("protein-picker");
  proteinPicker.addEventListener("click", (e) => {
    const btn = e.target.closest("button[data-protein]");
    if (!btn) return;
    for (const p of proteinPicker.querySelectorAll(".pill")) p.classList.remove("pill--active");
    btn.classList.add("pill--active");
    activeProtein = btn.dataset.protein;
    applyFilters();
  });

  // ── Bind tier ──
  const tierPicker = document.getElementById("tier-picker");
  tierPicker.addEventListener("click", (e) => {
    const btn = e.target.closest("button[data-tier]");
    if (!btn) return;
    for (const p of tierPicker.querySelectorAll(".pill")) p.classList.remove("pill--active");
    btn.classList.add("pill--active");
    activeTier = btn.dataset.tier;
    applyFilters();
  });

  // ── Bind prep time ──
  const prepPicker = document.getElementById("prep-picker");
  prepPicker.addEventListener("click", (e) => {
    const btn = e.target.closest("button[data-prep]");
    if (!btn) return;
    for (const p of prepPicker.querySelectorAll(".pill")) p.classList.remove("pill--active");
    btn.classList.add("pill--active");
    activeMaxPrep = parseInt(btn.dataset.prep, 10);
    applyFilters();
  });

  // ── Week plan links: scroll to card ──
  for (const link of document.querySelectorAll("[data-week-link]")) {
    link.addEventListener("click", (e) => {
      e.preventDefault();
      const id = link.getAttribute("href").slice(1);
      const card = document.querySelector(`[data-recipe-id="${id}"]`);
      if (card) {
        // Reset filters so card is visible
        if (card.hidden) {
          // Reset to all
          for (const p of document.querySelectorAll(".pill")) p.classList.remove("pill--active");
          document.querySelector("[data-protein='all']").classList.add("pill--active");
          document.querySelector("[data-tier='all']").classList.add("pill--active");
          document.querySelector("[data-prep='0']").classList.add("pill--active");
          activeProtein = "all"; activeTier = "all"; activeMaxPrep = 0;
          applyFilters();
        }
        card.scrollIntoView({ behavior: "smooth", block: "start" });
        card.classList.add("recipe-card--highlight");
        setTimeout(() => card.classList.remove("recipe-card--highlight"), 1800);
      }
    });
  }

  // ── Boot ──
  applySize("medium");
  applyFilters();
</script>

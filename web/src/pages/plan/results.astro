---
import BaseLayout from "../../layouts/BaseLayout.astro";
---

<BaseLayout title="Your Nutrition Plan" description="Personalized daily energy and feeding recommendations for your dog." container="md">

  <div class="pr" id="results-root">

    <a class="pr__back" id="edit-link" href="/plan">
      <svg width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><polyline points="15 18 9 12 15 6"/></svg>
      Edit profile
    </a>

    <div class="page-header reveal">
      <p class="section-label">Your Plan</p>
      <h1 class="section-headline" style="font-size:var(--text-3xl);">Nutrition Plan</h1>
      <p class="page-sub">Personalized energy and feeding recommendations based on your dog's profile.</p>
    </div>

    <!-- Dog profile summary -->
    <section class="pr__section reveal">
      <h2 class="pr__section-title">Dog profile</h2>
      <div id="dogs-profile"></div>
    </section>

    <!-- Energy breakdown -->
    <section class="pr__section reveal">
      <h2 class="pr__section-title">Energy calculation</h2>
      <div id="dogs-energy"></div>
    </section>

    <!-- Size category -->
    <section class="pr__section reveal">
      <h2 class="pr__section-title">Feeding guide</h2>
      <div id="dogs-guide"></div>
    </section>

    <!-- Recommended meal plan -->
    <section class="pr__section reveal">
      <h2 class="pr__section-title">Recipes</h2>
      <p class="page-sub" style="margin-bottom:var(--space-4);">
        Browse the recipe library and generate new recipes.
      </p>
      <div class="card" style="padding:var(--space-6);">
        <div style="display:flex;flex-wrap:wrap;gap:var(--space-3);align-items:center;justify-content:space-between;">
          <div style="max-width:60ch;">
            <strong>Recipe library</strong>
            <div class="small" style="color:var(--color-muted);margin-top:var(--space-1);">
              Legacy static recipes have been removed. Recipes now come from the generated recipe database.
            </div>
          </div>
          <div style="display:flex;gap:var(--space-3);flex-wrap:wrap;">
            <a class="button" href="/recipes">View recipes</a>
            <a class="button button--primary" href="/recipes/new">Generate recipe</a>
          </div>
        </div>
      </div>
    </section>

    <!-- Disclaimer -->
    <div class="pr__disclaimer reveal">
      This is a quick estimate based on standard MER formulas — not veterinary advice. Consult your vet before making dietary changes, especially for puppies, seniors, or dogs with health conditions.
    </div>

    <!-- No-params fallback (hidden by default) -->
    <div id="no-params" style="display:none;">
      <div class="card" style="padding:var(--space-8);text-align:center;">
        <p style="font-size:var(--text-lg);margin-bottom:var(--space-4);">No profile data found.</p>
        <a class="button button--primary" href="/plan">Build a plan</a>
      </div>
    </div>
  </div>

</BaseLayout>

<script>
  const LB_PER_KG = 2.2046226218;

  function kgToLb(kg) {
    return kg * LB_PER_KG;
  }

  function formatWeight(weightKg, units) {
    if (typeof weightKg !== 'number' || isNaN(weightKg)) return '—';
    if (units === 'imperial') return `${(Math.round(kgToLb(weightKg) * 10) / 10)} lb`;
    // keep kg fairly clean
    const rounded = Math.round(weightKg * 10) / 10;
    return `${rounded} kg`;
  }

  function formatRerWeight(weightKg, units) {
    const kg = Math.round(weightKg * 10) / 10;
    if (units !== 'imperial') return `${kg}`;
    const lb = Math.round(kgToLb(weightKg) * 10) / 10;
    return `${kg} <span style="color:var(--color-muted);">(≈ ${lb} lb)</span>`;
  }
  // ── MER calculation (same proven logic from plan form) ──
  function computeRER(weightKg) {
    return 70 * Math.pow(weightKg, 0.75);
  }

  function mealsPerDay(ageMonths) {
    if (ageMonths < 4) return 4;
    if (ageMonths < 12) return 3;
    return 2;
  }

  function merMultiplier({ ageMonths, neuterStatus, activityLevel, weightGoal, bcs }) {
    if (ageMonths < 4) return { mult: 3.0, reason: "Puppy (under 4 months)" };
    if (ageMonths < 12) return { mult: 2.0, reason: "Puppy (4–12 months)" };

    let base = neuterStatus === "neutered" ? 1.6 : 1.8;
    let reason = neuterStatus === "neutered" ? "Adult neutered baseline" : "Adult intact baseline";

    const activity = { sedentary: 1.4, moderate: base, active: 2.0, working: 3.0 };
    const activityMult = activity[activityLevel] ?? base;
    if (activityLevel !== "moderate") {
      base = activityMult;
      reason = `Adult ${activityLevel}`;
    }

    if (weightGoal === "lose") {
      base = Math.min(base, 1.0);
      reason += " + weight loss";
    } else if (weightGoal === "gain") {
      base = Math.max(base, 2.0);
      reason += " + weight gain";
    }

    if (bcs >= 7) {
      base *= 0.9;
      reason += " (BCS high)";
    } else if (bcs <= 3) {
      base *= 1.1;
      reason += " (BCS low)";
    }

    return { mult: base, reason };
  }

  function labelify(s) {
    return s.replace(/_/g, " ").replace(/\b\w/g, (c) => c.toUpperCase());
  }

  function thumbUrl(publicUrl) {
    if (!publicUrl) return "";
    try {
      const u = new URL(publicUrl);
      const marker = "/storage/v1/object/public/";
      const idx = u.pathname.indexOf(marker);
      if (idx < 0) return publicUrl;
      const rest = u.pathname.slice(idx + marker.length);
      u.pathname = u.pathname.slice(0, idx) + "/storage/v1/render/image/public/" + rest;
      u.search = "width=240&height=160&resize=cover&quality=60";
      return u.toString();
    } catch { return publicUrl; }
  }

  function sizeCategory(dailyKcal) {
    if (dailyKcal <= 750) return "small";
    if (dailyKcal <= 1200) return "medium";
    return "large";
  }

  // ── Read URL params ──
  const rawParams = new URLSearchParams(window.location.search);

  function normalizeParams(p) {
    // If this URL already uses dog_0_* fields, keep as-is.
    for (const k of p.keys()) {
      if (/^dog_\d+_/.test(k)) return p;
    }

    // Legacy single-dog support (old links): weight_kg, age_months, etc.
    const hasLegacy = p.has("weight_kg") || p.has("age_months") || p.has("activity_level") || p.has("neuter_status");
    if (!hasLegacy) return p;

    const n = new URLSearchParams(p);
    const legacyKeys = [
      "name",
      "breed",
      "weight_kg",
      "age_months",
      "bcs",
      "neuter_status",
      "activity_level",
      "weight_goal",
    ];
    for (const key of legacyKeys) {
      const v = n.get(key);
      if (v != null && v !== "") n.set(`dog_0_${key}`, v);
    }
    if (!n.get("dog_count")) n.set("dog_count", "1");
    return n;
  }

  const params = normalizeParams(rawParams);
  const units = params.get('units') === 'imperial' ? 'imperial' : 'metric';

  function readDogsFromParams() {
    const countFromParam = Number(params.get("dog_count")) || 0;

    let maxIdx = -1;
    for (const k of params.keys()) {
      const m = k.match(/^dog_(\d+)_/);
      if (m) maxIdx = Math.max(maxIdx, Number(m[1]));
    }

    const count = Math.max(1, countFromParam, maxIdx + 1);
    const dogs = [];

    for (let i = 0; i < count; i++) {
      const weightKg = parseFloat(params.get(`dog_${i}_weight_kg`) || "");
      const ageMonths = parseInt(params.get(`dog_${i}_age_months`) || "", 10);
      const bcs = parseInt(params.get(`dog_${i}_bcs`) || "5", 10);
      const neuterStatus = params.get(`dog_${i}_neuter_status`) || "neutered";
      const activityLevel = params.get(`dog_${i}_activity_level`) || "moderate";
      const weightGoal = params.get(`dog_${i}_weight_goal`) || "maintain";
      const breed = params.get(`dog_${i}_breed`) || "Mixed Breed";
      const name = (params.get(`dog_${i}_name`) || "").trim();

      dogs.push({ idx: i, name, breed, weightKg, ageMonths, bcs, neuterStatus, activityLevel, weightGoal });
    }

    return dogs.filter((d) => !isNaN(d.weightKg) && !isNaN(d.ageMonths));
  }

  const dogs = readDogsFromParams();

  const root = document.getElementById("results-root");
  const noParams = document.getElementById("no-params");

  if (dogs.length === 0) {
    // No valid params — show fallback
    for (const el of root.querySelectorAll(".page-header, .pr__section, .pr__back, .pr__disclaimer")) {
      el.style.display = "none";
    }
    noParams.style.display = "block";
  } else {
    // ── Edit link with params ──
    document.getElementById("edit-link").href = `/plan?${params.toString()}`;

    const profileHost = document.getElementById("dogs-profile");
    const energyHost = document.getElementById("dogs-energy");
    const guideHost = document.getElementById("dogs-guide");

    profileHost.innerHTML = "";
    energyHost.innerHTML = "";
    guideHost.innerHTML = "";

    for (const dog of dogs) {
      const rer = computeRER(dog.weightKg);
      const { mult, reason } = merMultiplier({
        ageMonths: dog.ageMonths,
        neuterStatus: dog.neuterStatus,
        activityLevel: dog.activityLevel,
        weightGoal: dog.weightGoal,
        bcs: dog.bcs,
      });
      const dailyKcal = rer * mult;
      const meals = mealsPerDay(dog.ageMonths);
      const perMeal = dailyKcal / meals;
      const size = sizeCategory(dailyKcal);

      const dogLabel = dog.name ? dog.name : `Dog ${dog.idx + 1}`;

      const tags = [
        { label: "Name", value: dogLabel },
        { label: "Breed", value: dog.breed },
        { label: "Weight", value: formatWeight(dog.weightKg, units) },
        { label: "Age", value: dog.ageMonths < 12 ? `${dog.ageMonths} months` : `${(dog.ageMonths / 12).toFixed(1)} years` },
        { label: "BCS", value: `${dog.bcs} / 9` },
        { label: "Status", value: labelify(dog.neuterStatus) },
        { label: "Activity", value: labelify(dog.activityLevel) },
        { label: "Goal", value: labelify(dog.weightGoal) },
      ];

      profileHost.insertAdjacentHTML(
        "beforeend",
        `<div class="pr__dog-block">
          <h3 class="pr__dog-title">${dogLabel}</h3>
          <div class="pr__profile">
            ${tags.map((t) => `<span class="pr__profile-tag"><strong>${t.label}:</strong>&nbsp;${t.value}</span>`).join("")}
          </div>
        </div>`,
      );

      energyHost.insertAdjacentHTML(
        "beforeend",
        `<div class="pr__dog-block">
          <h3 class="pr__dog-title">${dogLabel}</h3>
          <div class="pr__energy-card">
            <div class="pr__energy-row">
              <span class="pr__energy-label">Resting Energy (RER)</span>
              <span class="pr__energy-val">70 × ${formatRerWeight(dog.weightKg, units)}<sup>0.75</sup> = ${Math.round(rer)} kcal</span>
            </div>
            <div class="pr__energy-row">
              <span class="pr__energy-label">Multiplier</span>
              <span class="pr__energy-val">× ${mult.toFixed(2)} &mdash; ${reason}</span>
            </div>
            <div class="pr__energy-row pr__energy-row--total">
              <span class="pr__energy-label">Daily target</span>
              <span class="pr__energy-val">${Math.round(dailyKcal)} kcal / day</span>
            </div>
            <div class="pr__energy-row">
              <span class="pr__energy-label">Meals per day</span>
              <span class="pr__energy-val">${meals}</span>
            </div>
            <div class="pr__energy-row">
              <span class="pr__energy-label">Per meal</span>
              <span class="pr__energy-val">~${Math.round(perMeal)} kcal</span>
            </div>
          </div>
        </div>`,
      );

      guideHost.insertAdjacentHTML(
        "beforeend",
        `<div class="pr__dog-block">
          <h3 class="pr__dog-title">${dogLabel}</h3>
          <div class="pr__size-banner">
            Based on <strong>${Math.round(dailyKcal)} kcal/day</strong>, your dog falls in the
            <strong>${size.charAt(0).toUpperCase() + size.slice(1)}</strong> category.
          </div>
        </div>`,
      );
    }
  }
</script>

<script>
  import { setProfileFromParams } from "../../stores/dogProfile";

  /** Persist first dog's profile to localStorage for form pre-fill on return */
  function syncProfileToStore() {
    const params = new URLSearchParams(window.location.search);
    if (!params.has("dog_0_weight_kg")) return;

    // Remap dog_0_* params to flat store keys
    const fieldMap: Record<string, string> = {
      weight_kg: "dog_0_weight_kg",
      age_months: "dog_0_age_months",
      bcs: "dog_0_bcs",
      neuter_status: "dog_0_neuter_status",
      activity_level: "dog_0_activity_level",
      weight_goal: "dog_0_weight_goal",
      breed: "dog_0_breed",
    };

    const flat = new URLSearchParams();
    for (const [storeKey, formKey] of Object.entries(fieldMap)) {
      const val = params.get(formKey);
      if (val !== null) flat.set(storeKey, val);
    }
    setProfileFromParams(flat);
  }

  syncProfileToStore();
  document.addEventListener("astro:page-load", syncProfileToStore);
</script>
